e63ce1026de36b0d6be158a23e90876e
"use strict";

var rawAsap = require("./raw");

var freeTasks = [];
module.exports = asap;

function asap(task) {
  var rawTask;

  if (freeTasks.length) {
    rawTask = freeTasks.pop();
  } else {
    rawTask = new RawTask();
  }

  rawTask.task = task;
  rawTask.domain = process.domain;
  rawAsap(rawTask);
}

function RawTask() {
  this.task = null;
  this.domain = null;
}

RawTask.prototype.call = function () {
  if (this.domain) {
    this.domain.enter();
  }

  var threw = true;

  try {
    this.task.call();
    threw = false;

    if (this.domain) {
      this.domain.exit();
    }
  } finally {
    if (threw) {
      rawAsap.requestFlush();
    }

    this.task = null;
    this.domain = null;
    freeTasks.push(this);
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJyYXdBc2FwIiwicmVxdWlyZSIsImZyZWVUYXNrcyIsIm1vZHVsZSIsImV4cG9ydHMiLCJhc2FwIiwidGFzayIsInJhd1Rhc2siLCJsZW5ndGgiLCJwb3AiLCJSYXdUYXNrIiwiZG9tYWluIiwicHJvY2VzcyIsInByb3RvdHlwZSIsImNhbGwiLCJlbnRlciIsInRocmV3IiwiZXhpdCIsInJlcXVlc3RGbHVzaCIsInB1c2giXSwic291cmNlcyI6WyJhc2FwLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG52YXIgcmF3QXNhcCA9IHJlcXVpcmUoXCIuL3Jhd1wiKTtcbnZhciBmcmVlVGFza3MgPSBbXTtcblxuLyoqXG4gKiBDYWxscyBhIHRhc2sgYXMgc29vbiBhcyBwb3NzaWJsZSBhZnRlciByZXR1cm5pbmcsIGluIGl0cyBvd24gZXZlbnQsIHdpdGhcbiAqIHByaW9yaXR5IG92ZXIgSU8gZXZlbnRzLiBBbiBleGNlcHRpb24gdGhyb3duIGluIGEgdGFzayBjYW4gYmUgaGFuZGxlZCBieVxuICogYHByb2Nlc3Mub24oXCJ1bmNhdWdodEV4Y2VwdGlvblwiKSBvciBgZG9tYWluLm9uKFwiZXJyb3JcIilgLCBidXQgd2lsbCBvdGhlcndpc2VcbiAqIGNyYXNoIHRoZSBwcm9jZXNzLiBJZiB0aGUgZXJyb3IgaXMgaGFuZGxlZCwgYWxsIHN1YnNlcXVlbnQgdGFza3Mgd2lsbFxuICogcmVzdW1lLlxuICpcbiAqIEBwYXJhbSB7e2NhbGx9fSB0YXNrIEEgY2FsbGFibGUgb2JqZWN0LCB0eXBpY2FsbHkgYSBmdW5jdGlvbiB0aGF0IHRha2VzIG5vXG4gKiBhcmd1bWVudHMuXG4gKi9cbm1vZHVsZS5leHBvcnRzID0gYXNhcDtcbmZ1bmN0aW9uIGFzYXAodGFzaykge1xuICAgIHZhciByYXdUYXNrO1xuICAgIGlmIChmcmVlVGFza3MubGVuZ3RoKSB7XG4gICAgICAgIHJhd1Rhc2sgPSBmcmVlVGFza3MucG9wKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmF3VGFzayA9IG5ldyBSYXdUYXNrKCk7XG4gICAgfVxuICAgIHJhd1Rhc2sudGFzayA9IHRhc2s7XG4gICAgcmF3VGFzay5kb21haW4gPSBwcm9jZXNzLmRvbWFpbjtcbiAgICByYXdBc2FwKHJhd1Rhc2spO1xufVxuXG5mdW5jdGlvbiBSYXdUYXNrKCkge1xuICAgIHRoaXMudGFzayA9IG51bGw7XG4gICAgdGhpcy5kb21haW4gPSBudWxsO1xufVxuXG5SYXdUYXNrLnByb3RvdHlwZS5jYWxsID0gZnVuY3Rpb24gKCkge1xuICAgIGlmICh0aGlzLmRvbWFpbikge1xuICAgICAgICB0aGlzLmRvbWFpbi5lbnRlcigpO1xuICAgIH1cbiAgICB2YXIgdGhyZXcgPSB0cnVlO1xuICAgIHRyeSB7XG4gICAgICAgIHRoaXMudGFzay5jYWxsKCk7XG4gICAgICAgIHRocmV3ID0gZmFsc2U7XG4gICAgICAgIC8vIElmIHRoZSB0YXNrIHRocm93cyBhbiBleGNlcHRpb24gKHByZXN1bWFibHkpIE5vZGUuanMgcmVzdG9yZXMgdGhlXG4gICAgICAgIC8vIGRvbWFpbiBzdGFjayBmb3IgdGhlIG5leHQgZXZlbnQuXG4gICAgICAgIGlmICh0aGlzLmRvbWFpbikge1xuICAgICAgICAgICAgdGhpcy5kb21haW4uZXhpdCgpO1xuICAgICAgICB9XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgICAgLy8gV2UgdXNlIHRyeS9maW5hbGx5IGFuZCBhIHRocmV3IGZsYWcgdG8gYXZvaWQgbWVzc2luZyB1cCBzdGFjayB0cmFjZXNcbiAgICAgICAgLy8gd2hlbiB3ZSBjYXRjaCBhbmQgcmVsZWFzZSBlcnJvcnMuXG4gICAgICAgIGlmICh0aHJldykge1xuICAgICAgICAgICAgLy8gSW4gTm9kZS5qcywgdW5jYXVnaHQgZXhjZXB0aW9ucyBhcmUgY29uc2lkZXJlZCBmYXRhbCBlcnJvcnMuXG4gICAgICAgICAgICAvLyBSZS10aHJvdyB0aGVtIHRvIGludGVycnVwdCBmbHVzaGluZyFcbiAgICAgICAgICAgIC8vIEVuc3VyZSB0aGF0IGZsdXNoaW5nIGNvbnRpbnVlcyBpZiBhbiB1bmNhdWdodCBleGNlcHRpb24gaXNcbiAgICAgICAgICAgIC8vIHN1cHByZXNzZWQgbGlzdGVuaW5nIHByb2Nlc3Mub24oXCJ1bmNhdWdodEV4Y2VwdGlvblwiKSBvclxuICAgICAgICAgICAgLy8gZG9tYWluLm9uKFwiZXJyb3JcIikuXG4gICAgICAgICAgICByYXdBc2FwLnJlcXVlc3RGbHVzaCgpO1xuICAgICAgICB9XG4gICAgICAgIC8vIElmIHRoZSB0YXNrIHRocmV3IGFuIGVycm9yLCB3ZSBkbyBub3Qgd2FudCB0byBleGl0IHRoZSBkb21haW4gaGVyZS5cbiAgICAgICAgLy8gRXhpdGluZyB0aGUgZG9tYWluIHdvdWxkIHByZXZlbnQgdGhlIGRvbWFpbiBmcm9tIGNhdGNoaW5nIHRoZSBlcnJvci5cbiAgICAgICAgdGhpcy50YXNrID0gbnVsbDtcbiAgICAgICAgdGhpcy5kb21haW4gPSBudWxsO1xuICAgICAgICBmcmVlVGFza3MucHVzaCh0aGlzKTtcbiAgICB9XG59O1xuXG4iXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQUlBLE9BQU8sR0FBR0MsT0FBTyxDQUFDLE9BQUQsQ0FBckI7O0FBQ0EsSUFBSUMsU0FBUyxHQUFHLEVBQWhCO0FBWUFDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQkMsSUFBakI7O0FBQ0EsU0FBU0EsSUFBVCxDQUFjQyxJQUFkLEVBQW9CO0VBQ2hCLElBQUlDLE9BQUo7O0VBQ0EsSUFBSUwsU0FBUyxDQUFDTSxNQUFkLEVBQXNCO0lBQ2xCRCxPQUFPLEdBQUdMLFNBQVMsQ0FBQ08sR0FBVixFQUFWO0VBQ0gsQ0FGRCxNQUVPO0lBQ0hGLE9BQU8sR0FBRyxJQUFJRyxPQUFKLEVBQVY7RUFDSDs7RUFDREgsT0FBTyxDQUFDRCxJQUFSLEdBQWVBLElBQWY7RUFDQUMsT0FBTyxDQUFDSSxNQUFSLEdBQWlCQyxPQUFPLENBQUNELE1BQXpCO0VBQ0FYLE9BQU8sQ0FBQ08sT0FBRCxDQUFQO0FBQ0g7O0FBRUQsU0FBU0csT0FBVCxHQUFtQjtFQUNmLEtBQUtKLElBQUwsR0FBWSxJQUFaO0VBQ0EsS0FBS0ssTUFBTCxHQUFjLElBQWQ7QUFDSDs7QUFFREQsT0FBTyxDQUFDRyxTQUFSLENBQWtCQyxJQUFsQixHQUF5QixZQUFZO0VBQ2pDLElBQUksS0FBS0gsTUFBVCxFQUFpQjtJQUNiLEtBQUtBLE1BQUwsQ0FBWUksS0FBWjtFQUNIOztFQUNELElBQUlDLEtBQUssR0FBRyxJQUFaOztFQUNBLElBQUk7SUFDQSxLQUFLVixJQUFMLENBQVVRLElBQVY7SUFDQUUsS0FBSyxHQUFHLEtBQVI7O0lBR0EsSUFBSSxLQUFLTCxNQUFULEVBQWlCO01BQ2IsS0FBS0EsTUFBTCxDQUFZTSxJQUFaO0lBQ0g7RUFDSixDQVJELFNBUVU7SUFHTixJQUFJRCxLQUFKLEVBQVc7TUFNUGhCLE9BQU8sQ0FBQ2tCLFlBQVI7SUFDSDs7SUFHRCxLQUFLWixJQUFMLEdBQVksSUFBWjtJQUNBLEtBQUtLLE1BQUwsR0FBYyxJQUFkO0lBQ0FULFNBQVMsQ0FBQ2lCLElBQVYsQ0FBZSxJQUFmO0VBQ0g7QUFDSixDQTlCRCJ9