cf52ad5867f639445df405e2e6d77840
var Stream = require('stream').Stream;

var util = require('util');

module.exports = DelayedStream;

function DelayedStream() {
  this.source = null;
  this.dataSize = 0;
  this.maxDataSize = 1024 * 1024;
  this.pauseStream = true;
  this._maxDataSizeExceeded = false;
  this._released = false;
  this._bufferedEvents = [];
}

util.inherits(DelayedStream, Stream);

DelayedStream.create = function (source, options) {
  var delayedStream = new this();
  options = options || {};

  for (var option in options) {
    delayedStream[option] = options[option];
  }

  delayedStream.source = source;
  var realEmit = source.emit;

  source.emit = function () {
    delayedStream._handleEmit(arguments);

    return realEmit.apply(source, arguments);
  };

  source.on('error', function () {});

  if (delayedStream.pauseStream) {
    source.pause();
  }

  return delayedStream;
};

Object.defineProperty(DelayedStream.prototype, 'readable', {
  configurable: true,
  enumerable: true,
  get: function get() {
    return this.source.readable;
  }
});

DelayedStream.prototype.setEncoding = function () {
  return this.source.setEncoding.apply(this.source, arguments);
};

DelayedStream.prototype.resume = function () {
  if (!this._released) {
    this.release();
  }

  this.source.resume();
};

DelayedStream.prototype.pause = function () {
  this.source.pause();
};

DelayedStream.prototype.release = function () {
  this._released = true;

  this._bufferedEvents.forEach(function (args) {
    this.emit.apply(this, args);
  }.bind(this));

  this._bufferedEvents = [];
};

DelayedStream.prototype.pipe = function () {
  var r = Stream.prototype.pipe.apply(this, arguments);
  this.resume();
  return r;
};

DelayedStream.prototype._handleEmit = function (args) {
  if (this._released) {
    this.emit.apply(this, args);
    return;
  }

  if (args[0] === 'data') {
    this.dataSize += args[1].length;

    this._checkIfMaxDataSizeExceeded();
  }

  this._bufferedEvents.push(args);
};

DelayedStream.prototype._checkIfMaxDataSizeExceeded = function () {
  if (this._maxDataSizeExceeded) {
    return;
  }

  if (this.dataSize <= this.maxDataSize) {
    return;
  }

  this._maxDataSizeExceeded = true;
  var message = 'DelayedStream#maxDataSize of ' + this.maxDataSize + ' bytes exceeded.';
  this.emit('error', new Error(message));
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTdHJlYW0iLCJyZXF1aXJlIiwidXRpbCIsIm1vZHVsZSIsImV4cG9ydHMiLCJEZWxheWVkU3RyZWFtIiwic291cmNlIiwiZGF0YVNpemUiLCJtYXhEYXRhU2l6ZSIsInBhdXNlU3RyZWFtIiwiX21heERhdGFTaXplRXhjZWVkZWQiLCJfcmVsZWFzZWQiLCJfYnVmZmVyZWRFdmVudHMiLCJpbmhlcml0cyIsImNyZWF0ZSIsIm9wdGlvbnMiLCJkZWxheWVkU3RyZWFtIiwib3B0aW9uIiwicmVhbEVtaXQiLCJlbWl0IiwiX2hhbmRsZUVtaXQiLCJhcmd1bWVudHMiLCJhcHBseSIsIm9uIiwicGF1c2UiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsInByb3RvdHlwZSIsImNvbmZpZ3VyYWJsZSIsImVudW1lcmFibGUiLCJnZXQiLCJyZWFkYWJsZSIsInNldEVuY29kaW5nIiwicmVzdW1lIiwicmVsZWFzZSIsImZvckVhY2giLCJhcmdzIiwiYmluZCIsInBpcGUiLCJyIiwibGVuZ3RoIiwiX2NoZWNrSWZNYXhEYXRhU2l6ZUV4Y2VlZGVkIiwicHVzaCIsIm1lc3NhZ2UiLCJFcnJvciJdLCJzb3VyY2VzIjpbImRlbGF5ZWRfc3RyZWFtLmpzIl0sInNvdXJjZXNDb250ZW50IjpbInZhciBTdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKS5TdHJlYW07XG52YXIgdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKTtcblxubW9kdWxlLmV4cG9ydHMgPSBEZWxheWVkU3RyZWFtO1xuZnVuY3Rpb24gRGVsYXllZFN0cmVhbSgpIHtcbiAgdGhpcy5zb3VyY2UgPSBudWxsO1xuICB0aGlzLmRhdGFTaXplID0gMDtcbiAgdGhpcy5tYXhEYXRhU2l6ZSA9IDEwMjQgKiAxMDI0O1xuICB0aGlzLnBhdXNlU3RyZWFtID0gdHJ1ZTtcblxuICB0aGlzLl9tYXhEYXRhU2l6ZUV4Y2VlZGVkID0gZmFsc2U7XG4gIHRoaXMuX3JlbGVhc2VkID0gZmFsc2U7XG4gIHRoaXMuX2J1ZmZlcmVkRXZlbnRzID0gW107XG59XG51dGlsLmluaGVyaXRzKERlbGF5ZWRTdHJlYW0sIFN0cmVhbSk7XG5cbkRlbGF5ZWRTdHJlYW0uY3JlYXRlID0gZnVuY3Rpb24oc291cmNlLCBvcHRpb25zKSB7XG4gIHZhciBkZWxheWVkU3RyZWFtID0gbmV3IHRoaXMoKTtcblxuICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgZm9yICh2YXIgb3B0aW9uIGluIG9wdGlvbnMpIHtcbiAgICBkZWxheWVkU3RyZWFtW29wdGlvbl0gPSBvcHRpb25zW29wdGlvbl07XG4gIH1cblxuICBkZWxheWVkU3RyZWFtLnNvdXJjZSA9IHNvdXJjZTtcblxuICB2YXIgcmVhbEVtaXQgPSBzb3VyY2UuZW1pdDtcbiAgc291cmNlLmVtaXQgPSBmdW5jdGlvbigpIHtcbiAgICBkZWxheWVkU3RyZWFtLl9oYW5kbGVFbWl0KGFyZ3VtZW50cyk7XG4gICAgcmV0dXJuIHJlYWxFbWl0LmFwcGx5KHNvdXJjZSwgYXJndW1lbnRzKTtcbiAgfTtcblxuICBzb3VyY2Uub24oJ2Vycm9yJywgZnVuY3Rpb24oKSB7fSk7XG4gIGlmIChkZWxheWVkU3RyZWFtLnBhdXNlU3RyZWFtKSB7XG4gICAgc291cmNlLnBhdXNlKCk7XG4gIH1cblxuICByZXR1cm4gZGVsYXllZFN0cmVhbTtcbn07XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShEZWxheWVkU3RyZWFtLnByb3RvdHlwZSwgJ3JlYWRhYmxlJywge1xuICBjb25maWd1cmFibGU6IHRydWUsXG4gIGVudW1lcmFibGU6IHRydWUsXG4gIGdldDogZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuc291cmNlLnJlYWRhYmxlO1xuICB9XG59KTtcblxuRGVsYXllZFN0cmVhbS5wcm90b3R5cGUuc2V0RW5jb2RpbmcgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHRoaXMuc291cmNlLnNldEVuY29kaW5nLmFwcGx5KHRoaXMuc291cmNlLCBhcmd1bWVudHMpO1xufTtcblxuRGVsYXllZFN0cmVhbS5wcm90b3R5cGUucmVzdW1lID0gZnVuY3Rpb24oKSB7XG4gIGlmICghdGhpcy5fcmVsZWFzZWQpIHtcbiAgICB0aGlzLnJlbGVhc2UoKTtcbiAgfVxuXG4gIHRoaXMuc291cmNlLnJlc3VtZSgpO1xufTtcblxuRGVsYXllZFN0cmVhbS5wcm90b3R5cGUucGF1c2UgPSBmdW5jdGlvbigpIHtcbiAgdGhpcy5zb3VyY2UucGF1c2UoKTtcbn07XG5cbkRlbGF5ZWRTdHJlYW0ucHJvdG90eXBlLnJlbGVhc2UgPSBmdW5jdGlvbigpIHtcbiAgdGhpcy5fcmVsZWFzZWQgPSB0cnVlO1xuXG4gIHRoaXMuX2J1ZmZlcmVkRXZlbnRzLmZvckVhY2goZnVuY3Rpb24oYXJncykge1xuICAgIHRoaXMuZW1pdC5hcHBseSh0aGlzLCBhcmdzKTtcbiAgfS5iaW5kKHRoaXMpKTtcbiAgdGhpcy5fYnVmZmVyZWRFdmVudHMgPSBbXTtcbn07XG5cbkRlbGF5ZWRTdHJlYW0ucHJvdG90eXBlLnBpcGUgPSBmdW5jdGlvbigpIHtcbiAgdmFyIHIgPSBTdHJlYW0ucHJvdG90eXBlLnBpcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgdGhpcy5yZXN1bWUoKTtcbiAgcmV0dXJuIHI7XG59O1xuXG5EZWxheWVkU3RyZWFtLnByb3RvdHlwZS5faGFuZGxlRW1pdCA9IGZ1bmN0aW9uKGFyZ3MpIHtcbiAgaWYgKHRoaXMuX3JlbGVhc2VkKSB7XG4gICAgdGhpcy5lbWl0LmFwcGx5KHRoaXMsIGFyZ3MpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmIChhcmdzWzBdID09PSAnZGF0YScpIHtcbiAgICB0aGlzLmRhdGFTaXplICs9IGFyZ3NbMV0ubGVuZ3RoO1xuICAgIHRoaXMuX2NoZWNrSWZNYXhEYXRhU2l6ZUV4Y2VlZGVkKCk7XG4gIH1cblxuICB0aGlzLl9idWZmZXJlZEV2ZW50cy5wdXNoKGFyZ3MpO1xufTtcblxuRGVsYXllZFN0cmVhbS5wcm90b3R5cGUuX2NoZWNrSWZNYXhEYXRhU2l6ZUV4Y2VlZGVkID0gZnVuY3Rpb24oKSB7XG4gIGlmICh0aGlzLl9tYXhEYXRhU2l6ZUV4Y2VlZGVkKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKHRoaXMuZGF0YVNpemUgPD0gdGhpcy5tYXhEYXRhU2l6ZSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHRoaXMuX21heERhdGFTaXplRXhjZWVkZWQgPSB0cnVlO1xuICB2YXIgbWVzc2FnZSA9XG4gICAgJ0RlbGF5ZWRTdHJlYW0jbWF4RGF0YVNpemUgb2YgJyArIHRoaXMubWF4RGF0YVNpemUgKyAnIGJ5dGVzIGV4Y2VlZGVkLidcbiAgdGhpcy5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcihtZXNzYWdlKSk7XG59O1xuIl0sIm1hcHBpbmdzIjoiQUFBQSxJQUFJQSxNQUFNLEdBQUdDLE9BQU8sQ0FBQyxRQUFELENBQVAsQ0FBa0JELE1BQS9COztBQUNBLElBQUlFLElBQUksR0FBR0QsT0FBTyxDQUFDLE1BQUQsQ0FBbEI7O0FBRUFFLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQkMsYUFBakI7O0FBQ0EsU0FBU0EsYUFBVCxHQUF5QjtFQUN2QixLQUFLQyxNQUFMLEdBQWMsSUFBZDtFQUNBLEtBQUtDLFFBQUwsR0FBZ0IsQ0FBaEI7RUFDQSxLQUFLQyxXQUFMLEdBQW1CLE9BQU8sSUFBMUI7RUFDQSxLQUFLQyxXQUFMLEdBQW1CLElBQW5CO0VBRUEsS0FBS0Msb0JBQUwsR0FBNEIsS0FBNUI7RUFDQSxLQUFLQyxTQUFMLEdBQWlCLEtBQWpCO0VBQ0EsS0FBS0MsZUFBTCxHQUF1QixFQUF2QjtBQUNEOztBQUNEVixJQUFJLENBQUNXLFFBQUwsQ0FBY1IsYUFBZCxFQUE2QkwsTUFBN0I7O0FBRUFLLGFBQWEsQ0FBQ1MsTUFBZCxHQUF1QixVQUFTUixNQUFULEVBQWlCUyxPQUFqQixFQUEwQjtFQUMvQyxJQUFJQyxhQUFhLEdBQUcsSUFBSSxJQUFKLEVBQXBCO0VBRUFELE9BQU8sR0FBR0EsT0FBTyxJQUFJLEVBQXJCOztFQUNBLEtBQUssSUFBSUUsTUFBVCxJQUFtQkYsT0FBbkIsRUFBNEI7SUFDMUJD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