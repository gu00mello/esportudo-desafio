{"version":3,"names":["Object","defineProperty","exports","value","default","TestEnvironment","_vm","data","require","_fakeTimers","_jestMock","_jestUtil","denyList","Set","nodeGlobals","Map","getOwnPropertyNames","globalThis","filter","global","has","map","nodeGlobalsKey","descriptor","getOwnPropertyDescriptor","Error","NodeEnvironment","config","_context","customExportConditions","projectConfig","context","createContext","runInContext","assign","testEnvironmentOptions","contextGlobals","configurable","enumerable","get","val","writable","set","Buffer","ArrayBuffer","Uint8Array","installCommonGlobals","globals","Array","isArray","every","item","moduleMocker","ModuleMocker","timerIdToRef","id","ref","unref","timerRefToId","timer","undefined","fakeTimers","LegacyFakeTimers","timerConfig","idToRef","refToId","fakeTimersModern","ModernFakeTimers","dispose"],"sources":["index.js"],"sourcesContent":["'use strict';\n\nObject.defineProperty(exports, '__esModule', {\n  value: true\n});\nexports.default = exports.TestEnvironment = void 0;\n\nfunction _vm() {\n  const data = require('vm');\n\n  _vm = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _fakeTimers() {\n  const data = require('@jest/fake-timers');\n\n  _fakeTimers = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _jestMock() {\n  const data = require('jest-mock');\n\n  _jestMock = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _jestUtil() {\n  const data = require('jest-util');\n\n  _jestUtil = function () {\n    return data;\n  };\n\n  return data;\n}\n\n/**\n * Copyright (c) Facebook, Inc. and its affiliates. All Rights Reserved.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n// some globals we do not want, either because deprecated or we set it ourselves\nconst denyList = new Set([\n  'GLOBAL',\n  'root',\n  'global',\n  'Buffer',\n  'ArrayBuffer',\n  'Uint8Array', // if env is loaded within a jest test\n  'jest-symbol-do-not-touch'\n]);\nconst nodeGlobals = new Map(\n  Object.getOwnPropertyNames(globalThis)\n    .filter(global => !denyList.has(global))\n    .map(nodeGlobalsKey => {\n      const descriptor = Object.getOwnPropertyDescriptor(\n        globalThis,\n        nodeGlobalsKey\n      );\n\n      if (!descriptor) {\n        throw new Error(\n          `No property descriptor for ${nodeGlobalsKey}, this is a bug in Jest.`\n        );\n      }\n\n      return [nodeGlobalsKey, descriptor];\n    })\n);\n\nclass NodeEnvironment {\n  context;\n  fakeTimers;\n  fakeTimersModern;\n  global;\n  moduleMocker;\n  customExportConditions = ['node', 'node-addons']; // while `context` is unused, it should always be passed\n\n  constructor(config, _context) {\n    const {projectConfig} = config;\n    this.context = (0, _vm().createContext)();\n    const global = (this.global = (0, _vm().runInContext)(\n      'this',\n      Object.assign(this.context, projectConfig.testEnvironmentOptions)\n    ));\n    const contextGlobals = new Set(Object.getOwnPropertyNames(global));\n\n    for (const [nodeGlobalsKey, descriptor] of nodeGlobals) {\n      if (!contextGlobals.has(nodeGlobalsKey)) {\n        Object.defineProperty(global, nodeGlobalsKey, {\n          configurable: descriptor.configurable,\n          enumerable: descriptor.enumerable,\n\n          get() {\n            // @ts-expect-error: no index signature\n            const val = globalThis[nodeGlobalsKey]; // override lazy getter\n\n            Object.defineProperty(global, nodeGlobalsKey, {\n              configurable: descriptor.configurable,\n              enumerable: descriptor.enumerable,\n              value: val,\n              writable: descriptor.writable\n            });\n            return val;\n          },\n\n          set(val) {\n            // override lazy getter\n            Object.defineProperty(global, nodeGlobalsKey, {\n              configurable: descriptor.configurable,\n              enumerable: descriptor.enumerable,\n              value: val,\n              writable: true\n            });\n          }\n        });\n      }\n    }\n\n    global.global = global;\n    global.Buffer = Buffer;\n    global.ArrayBuffer = ArrayBuffer; // TextEncoder (global or via 'util') references a Uint8Array constructor\n    // different than the global one used by users in tests. This makes sure the\n    // same constructor is referenced by both.\n\n    global.Uint8Array = Uint8Array;\n    (0, _jestUtil().installCommonGlobals)(global, projectConfig.globals);\n\n    if ('customExportConditions' in projectConfig.testEnvironmentOptions) {\n      const {customExportConditions} = projectConfig.testEnvironmentOptions;\n\n      if (\n        Array.isArray(customExportConditions) &&\n        customExportConditions.every(item => typeof item === 'string')\n      ) {\n        this.customExportConditions = customExportConditions;\n      } else {\n        throw new Error(\n          'Custom export conditions specified but they are not an array of strings'\n        );\n      }\n    }\n\n    this.moduleMocker = new (_jestMock().ModuleMocker)(global);\n\n    const timerIdToRef = id => ({\n      id,\n\n      ref() {\n        return this;\n      },\n\n      unref() {\n        return this;\n      }\n    });\n\n    const timerRefToId = timer => (timer && timer.id) || undefined;\n\n    this.fakeTimers = new (_fakeTimers().LegacyFakeTimers)({\n      config: projectConfig,\n      global,\n      moduleMocker: this.moduleMocker,\n      timerConfig: {\n        idToRef: timerIdToRef,\n        refToId: timerRefToId\n      }\n    });\n    this.fakeTimersModern = new (_fakeTimers().ModernFakeTimers)({\n      config: projectConfig,\n      global\n    });\n  } // eslint-disable-next-line @typescript-eslint/no-empty-function\n\n  async setup() {}\n\n  async teardown() {\n    if (this.fakeTimers) {\n      this.fakeTimers.dispose();\n    }\n\n    if (this.fakeTimersModern) {\n      this.fakeTimersModern.dispose();\n    }\n\n    this.context = null;\n    this.fakeTimers = null;\n    this.fakeTimersModern = null;\n  }\n\n  exportConditions() {\n    return this.customExportConditions;\n  }\n\n  getVmContext() {\n    return this.context;\n  }\n}\n\nexports.default = NodeEnvironment;\nconst TestEnvironment = NodeEnvironment;\nexports.TestEnvironment = TestEnvironment;\n"],"mappings":"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"}